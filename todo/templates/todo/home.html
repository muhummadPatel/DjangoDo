{% extends "base_page.html" %}

{% block nav_ul_desktop_b %}
  <li><a href="{% url 'auth_logout' %}">Logout</li>
{% endblock nav_ul_desktop_b %}
{% block nav_ul_mobile_b %}
  <li><a href="{% url 'auth_logout' %}">Logout</li>
{% endblock nav_ul_mobile_b %}

{% block title_b %} DjangoDo - Home {% endblock title_b %}

{% block main_body_b %}
  <div class="container">
    <div class="row">
      <br />
      <h5>Welcome, <strong>{{ user.get_username }}</strong> !</h5>
    </div>

    <div class="row">
      <!-- todo lists card -->
      <ul class="col s12 m5 z-depth-2 collection with-header">
        <li class="collection-header"><h4>Lists</h4></li>
        <div id="user-list-names">
          <!-- populated by ajax request -->
        </div>

        <li id="add-list-btn" class="collection-item">
          <div>
            <a href="#add-list-modal" class="modal-trigger">
              <i class="material-icons md-18">add</i>
            </a>
          </div>
        </li>
      </ul>

      <!-- todo items card -->
      <ul class="col s12 m5 offset-m1 z-depth-2 collection with-header">
        <h4 id="active-list-name" class="collection-header">Todo Items</h4>
        <div id="list-items">
          <p id="list-items-prompt" class="light grey-text center">
            Please select a list from the 'Lists' card
          </p>
          <!-- populated by ajax request -->
        </div>

        <li id="add-list-btn" class="collection-item">
          <div>
            <a id="add-item-btn" href="#add-item-modal" class="modal-trigger hide">
              <i class="material-icons md-18">add</i>
            </a>
          </div>
        </li>
      </ul>
    </div>
  </div>


  <!-- modal: create new todolist -->
  <div id="add-list-modal" class="modal">
    <div class="modal-content">
      <h4>New Todo List</h4>

      <form id="new-list-form" method="post" action=".">
        {% csrf_token %}

        <div class="input-field">
          <input id="todolist-name" type="text" class="validate">
          <label for="todolist-name">List Name</label>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button class="modal-action modal-close btn orange waves-effect waves-light" form="new-list-form" type="submit" name="action">Create<i class="material-icons right">send</i></button>
    </div>
  </div>


  <!-- modal: add new item -->
  <div id="add-item-modal" class="modal">
    <div class="modal-content">
      <h4>New Todo Item</h4>

      <form id="new-item-form" method="post" action="">
        {% csrf_token %}

        <div class="input-field">
          <input id="todo-item-text" type="text" class="validate">
          <label for="todo-item-text">Todo Item Text</label>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button class="modal-action modal-close btn orange waves-effect waves-light" form="new-item-form" type="submit" name="action">Create<i class="material-icons right">send</i></button>
    </div>
  </div>
{% endblock main_body_b %}

{% block extra_js_b %}
  <script>
    (function($){
      update_lists();
    })(jQuery);

    // Get all the users lists and add them to the page
    function update_lists(){
      $("#user-list-names").empty();

      $.getJSON("/lists/", function(user_lists){
        $.each(user_lists, function(index, user_list){
          list_id = user_list["pk"];
          list_name = user_list["fields"]["name"];
          list_html = "<li class=\"collection-item\"><div><a id=\"listname_" + list_id + "\" href=\"#\">" + list_name + "</a><a id=\"deletelist_" + list_id + "\" href=\"#\" class=\"secondary-content\"><i class=\"material-icons md-18\">delete</i></a><div></li>"
          $("#user-list-names").append(list_html);
        });
      });
    }

    // Add a new list when the user submits the new-list-form
    $("#new-list-form").on('submit', function(event){
      event.preventDefault();

      list_name = $("#todolist-name").val();
      console.log("creating list:" + list_name);

      data = { todolist_name: list_name };
      $.post("/lists/", data, function(){
        console.log("Successfully created " + list_name);
        update_lists();
      }).fail(function(){
        console.log("Error. POST to create list failed.");
        alert("Sorry, an error occurred. :/");
      });
    });

    // Delete a list when the user clicks the trash can
    $("#user-list-names").on("click", ".secondary-content", function(){
      // get the id of the list to be deleted
      list_id = $(this).attr("id").match(/\d+/g);
      if(list_id.length == 0){
        console.log("Error. Could not identify id of list to be deleted.");
        alert("Sorry, an error occurred. :/");
      }else{
        list_id = list_id[0];
      }

      // POST to delete the specified list
      $.post("/lists/" + list_id + "/delete/", function(){
        console.log("Successfully deleted " + list_name);
        update_lists();
      }).fail(function(){
        console.log("Error. POST to delete list failed.");
        alert("Sorry, an error occurred. :/");
      });
    });

    // get the items of list 'list_id' and display them in the #list-items card
    function update_items(list_id){
      $.getJSON("/lists/" + list_id + "/items/" , function(list_items){
        $("#list-items-prompt").addClass("hide");
        $("#add-item-btn").removeClass("hide");
        $("#active-list-name").html(list_name);
        $("#list-items").empty();

        $.each(list_items, function(index, list_item){
          item_id = list_item["pk"];
          item_text = list_item["fields"]["item_text"];
          status = (list_item["fields"]["completed"])? "checked": "";

          cbox_id = "listitem_" + item_id;
          item_html = "<li class=\"collection-item\"><input id=\"" + cbox_id + "\" name=\"" + cbox_id + "\" type=\"checkbox\" " + status + "></input><label for=\"" + cbox_id + "\">" + item_text + "</label></li>"
          $("#list-items").append(item_html);
        });
        console.log(list_items);
      });
    }

    // When the user clicks on one of their lists, make it active and show the items
    $("#user-list-names").on("click", ".collection-item a", function(){
      // make the selected list active
      $(".collection-item").removeClass("active");
      $(this).closest(".collection-item").addClass("active");

      // get and display the items in this list
      list_name = $(this).text();
      list_id = $(this).attr("id").match(/\d+/g);
      if(list_id.length == 0){
        console.log("Error. Could not identify id of list to be displayed.");
        alert("Sorry, an error occurred. :/");
      }else{
        list_id = list_id[0];
      }
      update_items(list_id);
    });
  </script>
{% endblock extra_js_b %}
