{% extends "base_page.html" %}

{% block nav_ul_desktop_b %}
  <li><a href="{% url 'auth_logout' %}">Logout</li>
{% endblock nav_ul_desktop_b %}
{% block nav_ul_mobile_b %}
  <li><a href="{% url 'auth_logout' %}">Logout</li>
{% endblock nav_ul_mobile_b %}

{% block title_b %} DjangoDo - Home {% endblock title_b %}

{% block main_body_b %}
  <div class="container">
    <div class="row">
      <br />
      <h5>Welcome, <strong>{{ user.get_username }}</strong> !</h5>
    </div>

    <div class="row">
      <!-- todo lists card -->
      <div class="col s12 m5 z-depth-2 collection with-header">
        <h4 class="collection-header">Lists</h4>
        <div id="user-list-names">
          <!-- populated by ajax request -->
        </div>

        <a href="#add-list-modal" class="collection-item modal-trigger"><i class="material-icons md-18">add</i></a>
        <!--<a class="btn-floating btn-large waves-effect waves-light red"><i class="material-icons">add</i></a>-->
      </div>

      <!-- todo items card -->

      <div class="col s12 m5 offset-m1 z-depth-2 collection with-header">
        <h4 id="active-list-name" class="collection-header">Todo Items</h4>
        <div id="list-items">
          <p id="list-items-prompt">
            Please select one of your lists
          </p>
          <!-- populated by ajax request -->
        </div>

        <a href="#add-item-modal" class="collection-item modal-trigger hide"><i class="material-icons md-18">add</i></a>
        <!--<a class="btn-floating btn-large waves-effect waves-light red"><i class="material-icons">add</i></a>-->
      </div>
    </div>
  </div>


  <!-- modal: create new todolist -->
  <div id="add-list-modal" class="modal">
    <div class="modal-content">
      <h4>New Todo List</h4>

      <form id="new-list-form" method="post" action=".">
        {% csrf_token %}

        <div class="input-field">
          <input id="todolist-name" type="text" class="validate">
          <label for="todolist-name">List Name</label>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button class="modal-action modal-close btn orange waves-effect waves-light" form="new-list-form" type="submit" name="action">Create<i class="material-icons right">send</i></button>
    </div>
  </div>


  <!-- modal: add new item -->
  <div id="add-item-modal" class="modal">
    <div class="modal-content">
      <h4>New Todo Item</h4>

      <form id="new-item-form" method="post" action="">
        {% csrf_token %}

        <div class="input-field">
          <input id="todo-item-text" type="text" class="validate">
          <label for="todo-item-text">Todo Item Text</label>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button class="modal-action modal-close btn orange waves-effect waves-light" form="new-item-form" type="submit" name="action">Create<i class="material-icons right">send</i></button>
    </div>
  </div>
{% endblock main_body_b %}

{% block extra_js_b %}
  <script>
    (function($){
      update_lists();
    })(jQuery);

    // Get all the users lists and add them to the page
    function update_lists(){
      $("#user-list-names").empty();
      $.getJSON("{% url 'todo:lists'%}", function(user_lists){
        $.each(user_lists, function(index, user_list){
          list_id = user_list["pk"];
          list_name = user_list["fields"]["name"];
          $("#user-list-names").append("<a id=\"listid_" + list_id + "\" href=\"#\" class=\"collection-item\">" + list_name + "</a>");
        })
      });
    }

    // Add a new list when the user submits the new-list-form
    $("#new-list-form").on('submit', function(event){
      event.preventDefault();

      list_name = $("#todolist-name").val();
      console.log("creating list:" + list_name);
      
      data = { todolist_name: list_name };
      $.post("{% url 'todo:lists' %}", data, function(){
        console.log("Successfully created " + list_name);
        update_lists();
      }).fail(function(){
        alert("Sorry. Could not create " + list_name + ". :/");
      });
    });

    // When the user clicks on one of their lists, make it active and show the items
    $("#user-list-names").on("click", ".collection-item", function(){
      // make the selected list active
      $(".collection-item").removeClass("active");
      $(this).addClass("active");

      // get and display the items in this list
      // list_items = get_list_items(list_id)
      console.log($(this).attr("id"));
    });
  </script>
{% endblock extra_js_b %}
